## Post #1
- Username: AlphaTwentyThree
- Rank: double-veteran
- Number of posts: 982
- Joined date: Tue Aug 25, 2009 5:55 am
- Post datetime: 2009-12-02T14:56:46+00:00
- Post Title: [general] PSP multimedia formats *.at3 *.pmf

This is a thing that's been bothering me a long time now. There are many games with great music on the PSP. To get the music decoded is only possible with a PSP or by looping it through Sonic Stage via Himdrenderer. 
First of all, here are some sample files to look at: [http://www.sendspace.com/file/yedzi5](http://www.sendspace.com/file/yedzi5)

Now there are some obscurities with the format. In general, AT3plus files have a wave header with FE FF in the codec bytes (at 0x14, in case you don't know). In most cases these are decodable with Himdrenderer, but sometimes not. For example when they are mono. Another problem occurs with the offset 1C and 20. Till now I've only run into on of the following combinations:

```
-----|-----
 8D17 | 1801
 A01F | 7801
 1A2F | 3002
 943E | E802
 953E | E802
 355E | 6004
```
The crux is the last combination, which is unsupported by Sonic Stage and thus can't be decoded by Himdrenderer. 
Then there are normal ATRAC3 files which are supported after installing the codec ([http://www.minidisc.org/atrac3.zip](http://www.minidisc.org/atrac3.zip)). They have the codec number 70 02. Till now, I've encountered the following combinations:

```
-----|-----
 2433 | 3301
 4D20 | C000
 9A40 | 8001
```
Now what's strange? Well, when using Himdrenderer to create an OMA header (only possible with the supported formats), Sony Soundforge can open the atrac3+ files. Strangely no other audio editor can open the files but KMPlayer can play them. I couldn't find any information about this OMA header.
Last thing is the PMF files. These are modified MPG streams with at3 audio. There is no player that supports PMf at the moment and demuxing with Mplayer produces headerless AT3 files.
A last note on the looping points / cues. The looping cues from the AT3 files can be transferred to the WAVE file but are always a couple of ms too late. When rebuilding an at3 file with an OMA header, the looping information is lost. 

Now my question to the above facts:
1. How can a mono AT3 stream be rebuild to a stereo stream (so it can be decoded by Himdrenderer)? Shouldn't bee to hard with the block align, right?
2. Can a stream with the 355E/6004 combination be rebuild to another combination that is supported?
3. How is the structure of the OMA header? Where is the information from the WAVE header located?
4. Is it possible to build a working header for the 355E/6004 combination files to open them in Soundforge?
5. Where are the informations about the audio stream located inside the PMF header? Is it possible to write a program that adds a working AT3 header to the headerless at3 files? Or that demuxes to supported AT3 files?
6. How must the smpl bytes be corrected to point to the right place inside the wave stream? Could someone eventually write a bms script or little program that copies the smpl information from the AT3 file into the RIFF header and automatically corrects it?

Ok, that's it for now. I hope I don't bother you too much and that someone has answers or ideas to my questions.
The sample files are:
a file with AT3+ RIFF header
a file with AT3+ OMA header
the decoded WAV pendant from the above
an AT3 file (70 02)
a PMF video
a demuxed headerless at3 file from the video
## Post #2
- Username: AlphaTwentyThree
- Rank: double-veteran
- Number of posts: 982
- Joined date: Tue Aug 25, 2009 5:55 am
- Post datetime: 2010-01-02T13:40:18+00:00
- Post Title: [general] PSP multimedia formats *.at3 *.pmf

Does really no-one have any information? I've already written to the programmer of HMidRenderer but no answer so far.
Not even any information about the ATRAC format and about how to parse mono into stereo? I'd be really really thankful if someone could take a look at the sample files!
## Post #3
- Username: AlphaTwentyThree
- Rank: double-veteran
- Number of posts: 982
- Joined date: Tue Aug 25, 2009 5:55 am
- Post datetime: 2010-02-08T02:26:38+00:00
- Post Title: [general] PSP multimedia formats *.at3 *.pmf

Ok, here's an update as I've found out how to convert some of the above files. 
Offset 3F seems to be the important one to decode AT3+ files. I've encountered the values 22, 2E, 45, 5C and 8B. The unconvertable combination from above seems to belong to 8B. I have checked the OMA/AA3 header and realized that only this very information is necessary to construct a valid header. 
I've attached such an AA3 header, the bytes you need to change are at offset 0x0423. Once changed to the original bytes from the RIFF header and the stream attached (after data + 4 bytes), Sony SoundForge can open those files and thus decode them to WAV.
Maybe someone could write a little converter (exe file)? Should be really easy. (Save 0x3F byte, delete header, add AA3 header and write the byte to 0x0423).
That would be GREAT! 
[oma_header.7z](https://xentaxbackup.github.io/file/2774_oma_header.7z)
## Post #4
- Username: AlphaTwentyThree
- Rank: double-veteran
- Number of posts: 982
- Joined date: Tue Aug 25, 2009 5:55 am
- Post datetime: 2010-06-08T14:28:31+00:00
- Post Title: [general] PSP multimedia formats *.at3 *.pmf

Ok, gained some experience with quickBMS over the time, so here's the at3toaa3 converter. Looks a bit awkward because of the 0x460 byte OMA header.

```
goto 0x3c
get INFO long
FindLoc DATA STRING "data" 0 ""
math DATA += 4
goto DATA
get SIZE long
set MEMORY_FILE binary "\x65\x61\x33\x03\x00\x00\x00\x00\x07\x76\x47\x45\x4f\x42\x00\x00\x01\xc6\x00\x00\x02\x62\x69\x6e\x61\x72\x79\x00\x00\x00\x00\x4f\x00\x4d\x00\x47\x00\x5f\x00\x4c\x00\x53\x00\x49\x00\x00\x00\x01\x00\x40\x00\xdc\x00\x70\x00\x08\x00\x00\x00\x00\x00\x00\x4b\x45\x59\x52\x49\x4e\x47\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x45\x41\x33\x01\x00\x60\xff\xff\x00\x00\x00\x00\x01\x0f\x50\x00\x00\x04\x00\x00\x00\x4f\xc0\xb0\xfc\x03\x43\x26\x77\xa0\x45\xfb\x01\x00\x28\x5c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
putVarChr MEMORY_FILE 0x420 INFO long
append
log MEMORY_FILE 0x60 SIZE
append
get NAME basename
string NAME += ".aa3"
math SIZE += 0x460

log NAME 0 SIZE MEMORY_FILE
```
