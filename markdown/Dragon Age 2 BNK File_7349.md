## Post #1
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-12T21:57:07+00:00
- Post Title: Dragon Age 2 BNK File?

Greetings all!  I found your site from several other forums that deal with game files and I'm hoping to maybe solve a problem I'm having.  I did a couple of searches here but didn't find anything exactly like the issue I'm having, my apologies if I missed it somewhere.

While trying to pull apart and reassemble several of the files in DA2, I've come across these BNK files inside of an ERF archive.  I've been able to pull other ERF archives apart and gotten tons of OGG files that I can convert and mess with, but these BNK files are stumping me.  Based on looking at the file with a text editor, I'm pretty sure it's an audio file, but perhaps needs some conversion somehow (much like the OGG files did before they were playable).

As an example, here's what I get from one of the BNK files when opened in Notepad....

> BKHD   0   ¼D{               HIRC  U      ¡   ÝOd  CC €C  ÀÀ   A ÿ            ^CMBš™ÀÂ	     ‚Bš™ÀÂ                 ‚Bš™ÀÂ                  ‚B  ÈA           ÈB     @@    	     ‚B            ¹   »nñ
>
>   CC €C  ÀÀ   A ÿ               Bš™ÀÂ                 Bš™ÀÂ                  B  B           ÈB      @    	     ¨@         pA  ‚B	      A  ‚B     B            j   Ó|     P¼T	P¼T	      Æi£22  ö  ÀÀ                                                                     j   )é;     iÈ”iÈ”      Æi£22  ö  ÀÀ                                                                     j   ¢æÏ     WÌVWÌV      Æi£22  ö  ÀÀ                                                                     j   i à     mJmJ      Æi£22  ö  ÀÀ                                                                     j   tÉ?     êê      Æi£22  ö  ÀÀ                                                                     j   m
>
>      ‘§‘§      Æi£22  ö  ÀÀ                                                                     j   ðQ³     iÈ”iÈ”      Æi£22  ö  ÀÀ                                                                     j   ×D     3z3z      Æi£22  ö  ÀÀ                                                                     j   @B     ”H”H      Æi£22  ö  ÀÀ                                                                     j         öÁÑ
>
> öÁÑ
>
>       Æi£22  ö  ÀÀ                                                                     j   ßñx     öÁÑ
>
> öÁÑ
>
>       Æi£22  ö  ÀÀ                                                                     j   ôÖä"     
>
> 'ÿ 
>
> 'ÿ       Æi£22  ö  ÀÀ                                                                     j   r
>
> Á'     3z3z      Æi£22  ö  ÀÀ                                                                     j   óâ….     Ù)Ù)      Æi£22  ö  ÀÀ                                                                     j   óq2     WÌVWÌV      Æi£22  ö  ÀÀ                                                                     j   Øå4     Ù)Ù)      Æi£22  ö  ÀÀ                                                                     j   '<     ÉðwÉðw      Æi£22  ö  ÀÀ                                                                     j   ³s<     ÉðwÉðw      Æi£22  ö  ÀÀ                                                                     j   UG{<     
>
> 'ÿ 
>
> 'ÿ       Æi£22  ö  ÀÀ                                                                     j   B«<     mJmJ      Æi£22  ö  ÀÀ                                                                     j   øÐ!=     ”H”H      Æi£22  ö  ÀÀ                                                                     j   Dòß=     P¼T	P¼T	      Æi£22  ö  ÀÀ                                                                     j   ñ+>     ‘§‘§      Æi£22  ö  ÀÀ                                                                     j   Ç¸‹?     êê      Æi£22  ö  ÀÀ                                                                     ·   Æi£2      Áf
>
> Uö                                                                    Ó|)é;¢æÏi àtÉ?m
>
> ðQ³×D@B ßñxôÖä"r
>
> Á'óâ….óq2Øå4'<³s<UG{<B«<øÐ!=Dòß=ñ+>Ç¸‹?   [   Áf
>
>       u»02  ö                                                                    Æi£2   j   #–     ZƒYZƒY      ›À62  ö  ÀÀ                                                                     j   M's;     ZƒYZƒY      ›À62  ö  ÀÀ                                                                     _   ›À6      Á½qUö                                                                    #–M's;   r   Á½q  O(:u»0Z ö                                                    d         ÈB   ÝOd               ›À6   …  u»0    i  8             A  €?      Á  zD  €?        €;F  €?         C,õ    Z ö  ÀÀ                                                d         ÈB   »nñ
>
>             ÿŽð£R   bMa*    €¿  ˜A      €?           ÿŽð£R    ‚Pa(   €¿¤MÊÁ      €?ž‡¿    i  XñX   ÈÜç3       @œF	     €? `jF	      @ €;F	     @@ @F    i  ¯Xºw   hƒ         ÈB     ÈBžX‹D      Áf
>
> Á½q   A   ‡\í!@  óâ….            !                                  ¼D{      á&$   ‡\í!   A   _KÚ @  Øå4            !                                  ¼D{      ê&$   _KÚ    A   Ðúš)@  ¢æÏ            !                                  ¼D{      ×£(   Ðúš)   A   Š‰#@  óq2            !                                  ¼D{      Ü£(   Š‰#   A   °C5@  #–            !                                  ¼D{      Ñ÷A   °C5   A   ;¾J@  M's;            !                                  ¼D{      Ñ÷A   ;¾J   A   v+R?@  øÐ!=            !                                  ¼D{      SþA   v+R?   A   @ì‰@  @B            !                                  ¼D{      XþA   @ì‰   A   ‹½²:@  Ó|            !                                  ¼D{      v²‘P   ‹½²:   A   ¹Ã@  Dòß=            !                                  ¼D{      }²‘P   ¹Ã   A   ýc`;@  ×D            !                                  ¼D{      Ôð“P   ýc`;   A   þÕ @  r
>
> Á'            !                                  ¼D{      ßð“P   þÕ    A   P¬D5@  Ç¸‹?            !                                  ¼D{      7	‚   P¬D5   A   ¢Ò @  tÉ?            !                                  ¼D{      <	‚   ¢Ò    A   &Ù@  ðQ³            !                                  ¼D{      ÀŒ   &Ù   A   æÍ
>
> @  )é;            !                                  ¼D{      ËŒ   æÍ
>
>    A   Ñ¸•%@  '<            !                                  ¼D{      "EŽ   Ñ¸•%   A   z´6@  ³s<            !                                  ¼D{      )EŽ   z´6   A   0K+@  m
>
>             !                                  ¼D{      ”„®   0K+   A   -=+/@  ñ+>            !                                  ¼D{      Ÿ„®   -=+/   A   µ²J%@  B«<            !                                  ¼D{      Ã]2Ô   µ²J%   A   }Ã
>
> '@  i à            !                                  ¼D{      È]2Ô   }Ã
>
> '   A   ípÒ@  ßñx            !                                  ¼D{       £î   ípÒ   A   CËë@               !                                  ¼D{      «£î   CËë   A   (”}@  ôÖä"            !                                  ¼D{      (¿ø   (”}   A   +¼g3@  UG{<            !                                  ¼D{      (¿ø   +¼g3STID&         ¼D{lowtown_male_lowlife2_mob

Am I on the right track even or am I going in the totally wrong direction?
## Post #2
- Username: brendan19
- Rank: ultra-veteran
- Number of posts: 389
- Joined date: Thu Aug 12, 2010 3:15 pm
- Post datetime: 2011-09-14T22:14:06+00:00
- Post Title: Dragon Age 2 BNK File?

I think it is an audio archive based on previous experience with the header starting with "BKHD"

You need to identify what kind of audio is in the file. Get a hex editor and save the first 10MB of the file then upload it, post the link here so others can also take a look
## Post #3
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-14T22:30:10+00:00
- Post Title: Dragon Age 2 BNK File?

The contents of this post was deleted because of possible forum rules violation.
## Post #4
- Username: brendan19
- Rank: ultra-veteran
- Number of posts: 389
- Joined date: Thu Aug 12, 2010 3:15 pm
- Post datetime: 2011-09-14T22:52:14+00:00
- Post Title: Dragon Age 2 BNK File?

It's dialogue inside these files.

Get QuickBMS and use this script crafted by Alpha23 called the Wave Format Scanner

```
   FindLoc OFFSET STRING "WAVEfmt" 0 ""
   if OFFSET != ""
      math OFFSET -= 8
      goto OFFSET
      FindLoc DATA STRING "data" 0 ""
      math DATA += 4
      goto DATA
      get SSIZE long
      savepos HEADER
      math HEADER -= OFFSET
      set SIZE HEADER
      math SIZE += SSIZE
      get NAME basename
      string NAME += "_"
      string NAME += i
      string NAME += ".wav"
      log NAME OFFSET SIZE
   else
      cleanexit
   endif
next i
```


Run that script on the .BNK file and it'll give you a lot of .wav files. These need to be converted with WW2OGG but it doesn't really like the .wav files that much. It gives me a runtime error and I think it doesn't fully convert the file. You'll need to go to the HCS forum and ask them about the .wav files.

[http://hcs64.com/mboard/forum.php](http://hcs64.com/mboard/forum.php)
## Post #5
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-14T23:28:31+00:00
- Post Title: Dragon Age 2 BNK File?

> Reply from brendan19
>
> It's dialogue inside these files.

Get QuickBMS and use this script crafted by Alpha23 called the Wave Format Scanner

<snipped for size>

Run that script on the .BNK file and it'll give you a lot of .wav files. These need to be converted with WW2OGG but it doesn't really like the .wav files that much. It gives me a runtime error and I think it doesn't fully convert the file. You'll need to go to the HCS forum and ask them about the .wav files.

http://hcs64.com/mboard/forum.php

If you got it opened at all I'm thrilled though, it's a start at least and more than I've managed in a couple weeks of messing with it off and on.

Many thanks for the help, it's truly appreciate!

EDIT - Ok I got the WAVS and ran them through WW2OGG and it crashes like you said.  The output file is playable but cut off at the end (as expected from the crash).

There must be some other option other than WW2OGG, though I suppose with how rare the need is for such a thing, there may not be another option.

I'll try a little on my own before going to the HCS64 boards, but again I seriously appreciate the help in getting past that first hurdle.
## Post #6
- Username: brendan19
- Rank: ultra-veteran
- Number of posts: 389
- Joined date: Thu Aug 12, 2010 3:15 pm
- Post datetime: 2011-09-15T00:18:14+00:00
- Post Title: Dragon Age 2 BNK File?

I did somehow manage to do this in the past but I can't remember how exactly.

EDIT: From previous experience, what I used was chrrox's Dragon Age II script to extract the data from the .ERF archive then I used Alpha23's Wave Format Scanner script and finally HCS' ww2ogg which allowed me to convert the unlistenable .wav files into .ogg files.
## Post #7
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-15T00:51:12+00:00
- Post Title: Dragon Age 2 BNK File?

> Reply from brendan19
>
> I did somehow manage to do this in the past but I can't remember how exactly.

EDIT: From previous experience, what I used was chrrox's Dragon Age II script to extract the data from the .ERF archive then I used Alpha23's Wave Format Scanner script and finally HCS' ww2ogg which allowed me to convert the unlistenable .wav files into .ogg files.

For the music and NPC audio stuff that method is pretty much what I used and it worked flawlessly.

For the BNK files that have the party banter bits though, it crashes just like you mentioned when running through WW2OGG.

I made a post on the HCS forum with the error it gives and hoping someone can give me some answers.  Such a bugger to be so damn close and not able to make it work.
## Post #8
- Username: brendan19
- Rank: ultra-veteran
- Number of posts: 389
- Joined date: Thu Aug 12, 2010 3:15 pm
- Post datetime: 2011-09-15T01:07:15+00:00
- Post Title: Dragon Age 2 BNK File?

When it extracts the .wav files from the .bnk archive there are multiple RIFF headers inside the .wav file.

If I split the file into more .wav files starting with those RIFF headers, I get the error "RIFF Truncated" from ww2ogg.
## Post #9
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-15T01:14:08+00:00
- Post Title: Dragon Age 2 BNK File?

> Reply from brendan19
>
> When it extracts the .wav files from the .bnk archive there are multiple RIFF headers inside the .wav file.

If I split the file into more .wav files starting with those RIFF headers, I get the error "RIFF Truncated" from ww2ogg.

Hmm, I was just taking the wavs and tossing them through WW2OGG and I get the error of..

Terminate called after throwing an instance of 'Bit_uint<8u>::Int_too_big'

Then it crashes out, but the few bytes it wrote up to that point are playable and amount to maybe 1 second of audio.

So you're saying to split the first batch of WAVS into multiple WAVS for each RIFF in the original WAV files?
## Post #10
- Username: brendan19
- Rank: ultra-veteran
- Number of posts: 389
- Joined date: Thu Aug 12, 2010 3:15 pm
- Post datetime: 2011-09-15T01:47:48+00:00
- Post Title: Dragon Age 2 BNK File?

The extracted .wav files from the .bnk file contain more than just one RIFF header.

I split them at each of these RIFF headers and got that error instead of the one you mentioned.
## Post #11
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-15T01:50:46+00:00
- Post Title: Dragon Age 2 BNK File?

> Reply from brendan19
>
> The extracted .wav files from the .bnk file contain more than just one RIFF header.

I split them at each of these RIFF headers and got that error instead of the one you mentioned.

Hmm.  Well thats something else to look into I guess.

How were you splitting them up?  Then I can try and duplicate your results and work from there.
## Post #12
- Username: brendan19
- Rank: ultra-veteran
- Number of posts: 389
- Joined date: Thu Aug 12, 2010 3:15 pm
- Post datetime: 2011-09-15T02:03:47+00:00
- Post Title: Dragon Age 2 BNK File?

I used VGM Toolbox to split them up.

[http://sourceforge.net/projects/vgmtoolbox/](http://sourceforge.net/projects/vgmtoolbox/)

Also from the very talented coders over at HCS
## Post #13
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-15T02:42:38+00:00
- Post Title: Dragon Age 2 BNK File?

> Reply from brendan19
>
> I used VGM Toolbox to split them up.

http://sourceforge.net/projects/vgmtoolbox/

Also from the very talented coders over at HCS

Wow thats one heck of a toolbox.  Thanks for the link, now I can spend a few days just figuring out how to use all its options.
## Post #14
- Username: AlphaTwentyThree
- Rank: double-veteran
- Number of posts: 982
- Joined date: Tue Aug 25, 2009 5:55 am
- Post datetime: 2011-09-19T18:31:45+00:00
- Post Title: Dragon Age 2 BNK File?

You could also use my bnk extraction script:

```

FindLoc DIDX string "DIDX" 0 ""
if DIDX == ""
   print "DIDX section missing!"
   cleanexit
endif
math DIDX += 0x08
FindLoc DATA string "DATA" 0 ""
set FILES DATA
math FILES -= DIDX
math FILES /= 12
math DATA += 8
goto DIDX
get FULLNAME basename
string FULLNAME += "_"

for i = 1 <= FILES
   
   get ID long
   get OFFSET long
   math OFFSET += DATA
   get SIZE long
   math SIZE += 2
   set NAME FULLNAME
   string NAME += ID
   string NAME += ".wav"

   log NAME OFFSET SIZE

next i
```
## Post #15
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-19T20:15:37+00:00
- Post Title: Dragon Age 2 BNK File?

> Reply from AlphaTwentyThree
>
> You could also use my bnk extraction script:

Thanks very much!  I'll definately keep it on hand.

Still haven't made any progress on the files once they're out of the BNK archive though.  My post on the HCS forums has gone unanswered so I'm still picking away at them myself but not getting very far.
## Post #16
- Username: hcs
- Rank: mega-veteran
- Number of posts: 263
- Joined date: Mon Oct 19, 2009 4:41 am
- Post datetime: 2011-09-22T03:57:47+00:00
- Post Title: Re: Dragon Age 2 BNK File?

Thanks Alpha23, but it doesn't seem to work on this file. It looks like the headers are packed together in some way, it may be that there's a level of compression on top?  Or some kind of interleaving.  I'm investigating...

[edit]
In my opinion, this file only contains the headers and very start of these sounds, most of the data is somewhere else.  For instance, the first RIFF is missing about 19k (19010 bytes), I expect that is stashed away somewhere.  Maybe in a larger bnk?
## Post #17
- Username: AlphaTwentyThree
- Rank: double-veteran
- Number of posts: 982
- Joined date: Tue Aug 25, 2009 5:55 am
- Post datetime: 2011-09-22T19:36:12+00:00
- Post Title: Re: Dragon Age 2 BNK File?

Changed the script, works now! =) The file is little endian, my script was for big endian, so I just removed the reverseLong commands.
## Post #18
- Username: hcs
- Rank: mega-veteran
- Number of posts: 263
- Joined date: Mon Oct 19, 2009 4:41 am
- Post datetime: 2011-09-23T08:36:53+00:00
- Post Title: Re: Dragon Age 2 BNK File?

Yeah, but the files are still truncated, right?
## Post #19
- Username: B33ker
- Rank: ultra-n00b
- Number of posts: 9
- Joined date: Tue Sep 13, 2011 5:45 am
- Post datetime: 2011-09-23T15:37:10+00:00
- Post Title: Re: Dragon Age 2 BNK File?

Well, there are 654 BNK files total from the one ERF archive.

They range in size from 4MB to 2k with most of them being between 50k and 750k in size.

It's especially frustrating because all the other audio parts I've managed to extract just fine and they aren't cut off at all after running through WW2OGG.  Those bits are all combat screams and other stuff that isn't really what I'm after though, but it did get me some of the in game soundtrack parts that aren't on the offical soundtrack CD which was nice.

Sadly I just don't know enough to be useful other than blundering around blindly and hoping I hit on something that works, which hasn't happened yet.  I just keep wondering if the files would be truncated if WW2OGG wasnt crashing?

My thanks for the assistance so far, it's appreciated.
